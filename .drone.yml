---
kind: pipeline
name: Default

trigger:
  event:
    include:
      - push

steps:
  - name: Install js packages
    image: node:16
    volumes:
      - name: node_cache
        path: /tmp
    commands:
      - yarn config set cache-folder /tmp
      - yarn

  - name: Format js files
    image: node:14.17.0
    commands:
      - npx stylelint "src/**/*.scss" "src/**/*.vue" --fix
      - npx eslint src --ext .js,.vue,.ts --quiet --no-error-on-unmatched-pattern --fix
    depends_on:
      - Install js packages

  - name: Commit changes by js linter
    image: alpine/git
    commands:
      - git diff-index --quiet HEAD src || git add src
      - git diff-index --quiet HEAD src || git commit -m "[skip ci] :art:\ Format"
      - git pull origin $DRONE_TARGET_BRANCH --no-rebase
      - git push --set-upstream origin $DRONE_TARGET_BRANCH
    depends_on:
      - Format js files

  - name: Build assets
    image: node:16
    commands:
      - yarn build
    depends_on:
      - Install js packages

volumes:
  - name: node_cache
    host:
      path: /var/lib/node_cache

---
kind: pipeline
name: Deploy
depends_on:
  - Default

trigger:
  event:
    include:
      - tag
      - push
  branch:
    - master

steps:
  - name: Install js packages
    image: node:16
    volumes:
      - name: node_cache
        path: /tmp
    commands:
      - yarn config set cache-folder /tmp
      - yarn

  - name: Build assets
    image: node:16
    commands:
      - yarn build
    depends_on:
      - Install js packages

  - name: Upload assets
    image: robvankeilegom/ssh-rsync
    environment:
      SSH_KEY:
        from_secret: drone_ssh_key
      SSH_USER:
        from_secret: drone_ssh_user
      SSH_PORT:
        from_secret: drone_ssh_port
    commands:
      - eval `ssh-agent -s`
      - echo "$SSH_KEY" | ssh-add -
      - mkdir -p ~/.ssh && touch ~/.ssh/known_hosts
      - ssh-keyscan -p $SSH_PORT apache-conf-generator.robvankeilegom.be >> ~/.ssh/known_hosts
      - |
        rsync -av \
        -e "ssh -p $SSH_PORT" \
        /drone/src/dist/ \
        $SSH_USER@apache-conf-generator.robvankeilegom.be:~/websites/apache-conf-generator.robvankeilegom.be/current/
    depends_on:
      - Build assets
